<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#4f7cff">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Sumas y Restas (8 años) • Niveles + Exportar</title>
<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --text:#1a1f36; --muted:#5c6b8a;
    --accent:#4f7cff; --accent2:#00b894; --danger:#ff7675; --border:#e4e8f1;
    --focus:#99b3ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
    background:linear-gradient(180deg,#f1f5ff, #f7f9fc 40%); color:var(--text);
  }
  .wrap{max-width:960px; margin:24px auto; padding:16px;}
  header{display:flex; flex-wrap:wrap; align-items:center; gap:12px; margin-bottom:16px;}
  header h1{ font-size:1.35rem; margin:0; }
  .pill{ background:#eef2ff; color:#2f3c7a; padding:6px 10px; border-radius:999px; font-weight:700; }
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:12px;
    box-shadow:0 8px 24px rgba(28,44,80,0.06);
    padding:16px; margin-bottom:16px;
  }
  .controls{ display:grid; gap:12px; grid-template-columns: repeat(12, 1fr); }
  .controls .field{ grid-column: span 12; }
  @media(min-width:680px){
    .controls .field.sm-6{ grid-column: span 6; }
    .controls .field.sm-4{ grid-column: span 4; }
    .controls .field.sm-3{ grid-column: span 3; }
  }
  label{ display:block; font-size:0.9rem; color:var(--muted); margin-bottom:6px; }
  input[type="text"], select{
    width:100%; padding:12px 12px; border:1px solid var(--border); border-radius:10px;
    font-size:1rem; background:#fff; color:var(--text);
  }
  input[type="checkbox"]{ transform:scale(1.1); margin-right:6px; }
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:12px 14px; border-radius:10px; border:1px solid transparent;
    background:var(--accent); color:#fff; font-weight:700; cursor:pointer; touch-action:manipulation;
  }
  .btn.secondary{ background:#fff; color:var(--text); border-color:var(--border); }
  .btn.danger{ background:var(--danger); }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }
  .inline-actions{ display:flex; gap:10px; flex-wrap:wrap; }
  .game{ display:grid; gap:14px; grid-template-columns:1fr; align-items:center; justify-items:center; }
  .problem{
    font-variant-numeric: tabular-nums;
    font-size: clamp(30px, 8vw, 56px);
    font-weight:800; letter-spacing:.5px; text-align:center; line-height:1.15;
  }
  .answer-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center; }
  .answer-row input{
    width:min(180px, 46vw); text-align:center; font-size:1.5rem; font-weight:800;
    padding:14px; border-radius:12px; border:2px solid var(--border);
  }
  .answer-row input:focus{ outline:none; border-color:var(--focus); box-shadow:0 0 0 4px rgba(79,124,255,.15); }
  .feedback{ min-height:28px; font-weight:800; }
  .feedback.ok{ color:var(--accent2); }
  .feedback.no{ color:var(--danger); }
  .stats{
    display:flex; gap:18px; flex-wrap:wrap; justify-content:center; color:var(--muted);
    font-weight:700;
  }
  .progress{ width:100%; height:10px; background:#eef2f7; border-radius:999px; overflow:hidden; }
  .progress > span{ display:block; height:100%; width:0%; background:var(--accent); transition:width .25s ease; }
  .keypad{ display:grid; grid-template-columns:repeat(3, min(96px, 24vw)); gap:10px; justify-content:center; }
  .keypad button{
    padding:16px; font-size:1.2rem; border-radius:12px; border:1px solid var(--border); background:#fff; cursor:pointer;
  }
  .muted{ color:var(--muted); font-size:.9rem; }
  .sr-only{ position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
  footer{ text-align:center; color:var(--muted); font-size:.9rem; padding:12px 0; }
  .toggle{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; cursor:pointer; user-select:none; }
  .save-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Actividad de Sumas y Restas</h1>
      <span class="pill">8 años • Niveles • Exportar • Offline</span>
    </header>

    <section class="card" aria-labelledby="config-title">
      <h2 id="config-title" class="sr-only">Configuración</h2>
      <div class="controls">
        <div class="field sm-6">
          <label for="alumno">Nombre (opcional)</label>
          <input id="alumno" type="text" placeholder="Ej.: Lucía" />
        </div>
        <div class="field sm-3">
          <label for="modo">Modo</label>
          <select id="modo">
            <option value="ronda">Ronda de 10</option>
            <option value="practica">Práctica libre</option>
          </select>
        </div>
        <div class="field sm-3">
          <label for="operacion">Operación</label>
          <select id="operacion">
            <option value="suma">Sumas</option>
            <option value="resta">Restas</option>
            <option value="mixto" selected>Mixto</option>
          </select>
        </div>
        <div class="field sm-3">
          <label for="nivel">Nivel</label>
          <select id="nivel" title="Dificultad">
            <option value="1" selected>Nivel 1 · Sin llevadas</option>
            <option value="2">Nivel 2 · Llevada/préstamo simple</option>
            <option value="3">Nivel 3 · Llevadas frecuentes</option>
          </select>
        </div>
        <div class="field sm-3">
          <label for="rango">Rango de números</label>
          <select id="rango">
            <option value="20">0 a 20</option>
            <option value="50">0 a 50</option>
            <option value="100" selected>0 a 100</option>
          </select>
        </div>
        <div class="field sm-3">
          <label for="tiempo">Tiempo por ejercicio</label>
          <select id="tiempo">
            <option value="0">Sin límite</option>
            <option value="20">20 s</option>
            <option value="15" selected>15 s</option>
            <option value="10">10 s</option>
          </select>
        </div>
        <div class="field sm-3">
          <label class="toggle" for="sinNeg">
            <input id="sinNeg" type="checkbox" checked />
            Evitar resultados negativos
          </label>
        </div>
        <div class="field sm-6">
          <label class="toggle" for="sonido">
            <input id="sonido" type="checkbox" checked />
            Sonido de acierto / error
          </label>
        </div>
      </div>

      <div class="inline-actions" style="margin-top:12px">
        <button id="iniciar" class="btn" aria-label="Iniciar actividad">Iniciar</button>
        <button id="reiniciar" class="btn secondary" aria-label="Reiniciar" disabled>Reiniciar</button>
      </div>
    </section>

    <section id="juego" class="card" aria-live="polite" aria-atomic="true">
      <div class="game">
        <div class="problem" id="enunciado" aria-label="Operación actual">Pulsa “Iniciar” para empezar</div>

        <div class="answer-row">
          <label class="sr-only" for="respuesta">Respuesta</label>
          <input id="respuesta" type="text" inputmode="numeric" autocomplete="off" disabled placeholder="¿Resultado?" />
          <button id="comprobar" class="btn" disabled>Comprobar (↵)</button>
          <button id="saltar" class="btn secondary" disabled>Saltar</button>
        </div>

        <div class="feedback" id="feedback" role="status"></div>

        <div class="stats">
          <div><strong>Correctas:</strong> <span id="ok">0</span></div>
          <div><strong>Intentos:</strong> <span id="intentos">0</span></div>
          <div><strong>Racha:</strong> <span id="racha">0</span></div>
          <div><strong>Tiempo:</strong> <span id="contador">—</span></div>
        </div>

        <div class="progress" aria-label="Progreso de la ronda">
          <span id="barra"></span>
        </div>

        <div class="keypad" aria-label="Teclado numérico"></div>

        <div class="save-row">
          <button id="exportCSV" class="btn secondary" disabled>Exportar CSV</button>
          <button id="exportJSON" class="btn secondary" disabled>Exportar JSON</button>
          <button id="clearLS" class="btn danger" title="Borrar historial guardado" disabled>Borrar historial</button>
          <span class="muted" id="contadorHistorial">Historial: 0 intentos</span>
        </div>

        <div class="muted" id="ayuda">Consejo: también puedes escribir con el teclado y pulsar Enter.</div>
      </div>
    </section>

    <section id="resumen" class="card" hidden>
      <h2>Resumen</h2>
      <p id="resumenTxt"></p>
      <div class="inline-actions">
        <button class="btn" id="otraRonda">Otra ronda</button>
        <button class="btn secondary" id="practicar">Pasar a práctica</button>
      </div>
    </section>

    <footer>© Actividad educativa • Sin conexión • Funciona como app (PWA)</footer>
  </div>

<script>
// Registrar service worker para modo "app" offline
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js');
  });
}
</script>

<script>
/* --- Lógica de la actividad (igual que antes) --- */
(() => {
  const $ = s => document.querySelector(s);
  const enun = $('#enunciado'), ans = $('#respuesta'), btnGo = $('#comprobar'),
        btnStart = $('#iniciar'), btnReset = $('#reiniciar'), btnSkip = $('#saltar'),
        spanOk = $('#ok'), spanTry = $('#intentos'), spanStreak = $('#racha'),
        spanTime = $('#contador'), bar = $('#barra'), feedback = $('#feedback'),
        resumen = $('#resumen'), resumenTxt = $('#resumenTxt'),
        otraRonda = $('#otraRonda'), practicar = $('#practicar'),
        keypad = document.querySelector('.keypad');

  const selModo = $('#modo'), selOp = $('#operacion'), selRango = $('#rango'),
        selTiempo = $('#tiempo'), chkSinNeg = $('#sinNeg'), chkSonido = $('#sonido'),
        alumno = $('#alumno'), selNivel = $('#nivel');

  const btnCSV = $('#exportCSV'), btnJSON = $('#exportJSON'), btnClear = $('#clearLS'),
        lblHist = $('#contadorHistorial');

  const state = {
    activo:false, modo:'ronda', objetivo:10, total:0, ok:0, streak:0, streakMax:0,
    a:0, b:0, op:'+', sol:null, timer:null, tleft:0,
    rango:100, tiempo:15, sinNeg:true, nivel:1
  };

  const LS_KEY = 'actividadSR_historial_v1';
  let historial = loadHistorial();
  updateHistUI();

  function loadHistorial(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr)? arr : [];
    }catch(e){ return []; }
  }
  function saveHistorial(){
    try{
      localStorage.setItem(LS_KEY, JSON.stringify(historial));
    }catch(e){}
    updateHistUI();
  }
  function updateHistUI(){
    const n = historial.length;
    lblHist.textContent = `Historial: ${n} intento${n===1?'':'s'}`;
    const enabled = n>0;
    btnCSV.disabled = !enabled; btnJSON.disabled=!enabled; btnClear.disabled=!enabled;
  }

  function exportar(tipo='csv'){
    if(historial.length===0) return;
    const nombre = (alumno.value?.trim()||'alumno').replace(/\s+/g,'_');
    const fecha = new Date().toISOString().replace(/[:.]/g,'-');
    if(tipo==='json'){
      const blob = new Blob([JSON.stringify(historial,null,2)], {type:'application/json'});
      descargar(blob, `resultados_${nombre}_${fecha}.json`);
    }else{
      const head = ['timestamp','alumno','modo','nivel','operacion','rango','tiempoPorEj','sinNegativos','a','op','b','sol','respuesta','correcta','tiempoRestante','rachaTrasIntento'];
      const rows = historial.map(r=>[
        r.timestamp, r.alumno, r.modo, r.nivel, r.operacion, r.rango, r.tiempoPorEj, r.sinNegativos,
        r.a, r.op, r.b, r.sol, r.respuesta, r.correcta, r.tiempoRestante, r.rachaTrasIntento
      ]);
      const csv = [head.join(','), ...rows.map(fila => fila.map(v => {
        if(v===null || v===undefined) return '';
        const s = String(v);
        return /[\",\n]/.test(s) ? '\"' + s.replace(/\"/g,'\"\"') + '\"' : s;
      }).join(','))].join('\\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      descargar(blob, `resultados_${nombre}_${fecha}.csv`);
    }
  }
  function descargar(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
  }

  let ctx; function beep(ok=true){
    if(!chkSonido.checked) return;
    try{
      ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type='sine'; o.frequency.value = ok? 880 : 220;
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.15);
      o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.16);
    }catch(e){}
  }

  function nextProblem(){
    state.rango = parseInt(selRango.value,10);
    state.sinNeg = chkSinNeg.checked;
    state.modo = selModo.value;
    state.tiempo = parseInt(selTiempo.value,10);
    state.nivel = parseInt(selNivel.value,10);

    const modeOp = selOp.value;
    state.op = modeOp==='mixto' ? (Math.random()<0.5?'+':'-') : (modeOp==='suma'?'+':'-');

    let a,b,tries=0;
    do{
      ({a,b} = generarPar(state.rango, state.op, state.nivel, state.sinNeg));
      tries++;
      if(tries>200){
        a=Math.floor(Math.random()* (state.rango+1));
        b=Math.floor(Math.random()* (state.rango+1));
        if(state.op==='-' && state.sinNeg && a<b){ const t=a; a=b; b=t; }
        break;
      }
    }while(!esValidoNivel(a,b,state.op,state.nivel,state.sinNeg));

    state.a=a; state.b=b;
    state.sol = state.op==='+' ? (a+b) : (a-b);
    enun.textContent = `${a} ${state.op} ${b} =`;
    feedback.textContent = '';
    feedback.className = 'feedback';
    ans.value='';
    if(state.tiempo>0){ startTimer(state.tiempo); } else { spanTime.textContent = '—'; }
  }

  function generarPar(rango, op, nivel, sinNeg){
    let a = rand(0, rango), b = rand(0, rango);
    if(op==='-'){
      if(sinNeg && a<b){ const tmp=a; a=b; b=tmp; }
      if(sinNeg) a = Math.max(a,b);
    }
    return {a,b};
  }

  function esValidoNivel(a,b,op,nivel,sinNeg){
    const au=a%10, bu=b%10;
    if(op==='-' && sinNeg && a<b) return false;

    if(nivel===1){
      if(op==='+') return au + bu < 10;
      else return au >= bu;
    }
    if(nivel===2){
      if(op==='+') return au + bu >= 10;
      else {
        if(sinNeg && a<b) return false;
        return au < bu;
      }
    }
    if(nivel===3){
      if(op==='+') return au + bu >= 9;
      else {
        if(sinNeg && a<b) return false;
        return au <= bu;
      }
    }
    return true;
  }

  function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  function start(){
    state.activo=true; state.ok=0; state.total=0; state.streak=0; state.streakMax=0;
    resumen.hidden = true;
    updateStats();
    setUIActive(true);
    updateProgress();
    nextProblem();
  }

  function finish(){
    state.activo=false;
    setUIActive(false);
    btnStart.disabled=false;
    clearInterval(state.timer); spanTime.textContent='—';
    const nombre = alumno.value?.trim() || 'Alumno/a';
    const pct = state.total ? Math.round(100*state.ok/state.total) : 0;
    resumenTxt.textContent = `${nombre}: ${state.ok}/${state.total} correctas (${pct}%). Racha máxima: ${state.streakMax||0}.`;
    resumen.hidden = false;
  }

  function check(){
    if(!state.activo) return;
    const val = ans.value.trim();
    if(val==='') { mark(false, 'Escribe un número'); return; }
    const num = Number(val);
    if(!Number.isFinite(num)) { mark(false, 'Entrada no válida'); return; }
    const ok = (num === state.sol);
    mark(ok, ok?'¡Muy bien!':'Vuelve a intentarlo');

    state.total++;
    if(ok){ state.ok++; state.streak=(state.streak||0)+1; state.streakMax = Math.max(state.streakMax||0, state.streak); }
    else{ state.streak=0; }

    pushIntento(num, ok);

    updateStats();
    updateProgress();

    if(ok){
      if(state.modo==='ronda' && state.total >= state.objetivo){ finish(); return; }
      nextProblem();
    }
  }

  function pushIntento(respuesta, correcta){
    const rec = {
      timestamp: new Date().toISOString(),
      alumno: alumno.value?.trim() || '',
      modo: state.modo,
      nivel: state.nivel,
      operacion: selOp.value,
      rango: state.rango,
      tiempoPorEj: state.tiempo,
      sinNegativos: state.sinNeg,
      a: state.a, op: state.op, b: state.b, sol: state.sol,
      respuesta: respuesta,
      correcta: !!correcta,
      tiempoRestante: state.tiempo>0 ? state.tleft : null,
      rachaTrasIntento: state.streak
    };
    historial.push(rec);
    if(historial.length>5000){ historial.splice(0, historial.length-5000); }
    saveHistorial();
  }

  function skip(){
    if(!state.activo) return;
    state.total++;
    state.streak=0;
    updateStats(); updateProgress();
    feedback.textContent = `La respuesta era ${state.sol}`;
    feedback.className = 'feedback no';
    beep(false);
    pushIntento('', false);

    if(state.modo==='ronda' && state.total >= state.objetivo){ finish(); return; }
    nextProblem();
  }

  function mark(ok, msg){
    feedback.textContent = msg || (ok?'¡Correcto!':'Incorrecto');
    feedback.className = 'feedback ' + (ok?'ok':'no');
    beep(ok);
    ans.style.borderColor = ok ? 'var(--accent2)' : 'var(--danger)';
    setTimeout(()=> ans.style.borderColor = 'var(--border)', 250);
  }

  function updateStats(){
    spanOk.textContent = state.ok;
    spanTry.textContent = state.total;
    spanStreak.textContent = state.streak||0;
  }

  function updateProgress(){
    if(state.modo==='ronda'){
      const pct = Math.min(100, Math.round(100*state.total/state.objetivo));
      bar.style.width = pct + '%';
    } else {
      bar.style.width = '0%';
    }
  }

  function setUIActive(active){
    ans.disabled = btnGo.disabled = btnSkip.disabled = !active;
    btnReset.disabled = !active;
    btnStart.disabled = active;
    if(active){ ans.focus(); ans.select(); }
  }

  function startTimer(seconds){
    clearInterval(state.timer);
    state.tleft = seconds;
    spanTime.textContent = formatTime(state.tleft);
    state.timer = setInterval(()=>{
      state.tleft--;
      spanTime.textContent = formatTime(state.tleft);
      if(state.tleft<=0){
        clearInterval(state.timer);
        feedback.textContent = '⏳ Tiempo agotado';
        feedback.className = 'feedback no';
        beep(false);
        skip();
      }
    },1000);
  }

  function formatTime(s){
    const m = Math.floor(s/60), r = s%60;
    return (m>0? m+':' : '') + String(r).padStart(2,'0');
  }

  btnStart.addEventListener('click', start);
  btnReset.addEventListener('click', ()=>{ clearInterval(state.timer); start(); });
  btnGo.addEventListener('click', check);
  btnSkip.addEventListener('click', skip);
  otraRonda.addEventListener('click', ()=>{ selModo.value='ronda'; start(); window.scrollTo({top:0, behavior:'smooth'}); });
  practicar.addEventListener('click', ()=>{ selModo.value='practica'; start(); window.scrollTo({top:0, behavior:'smooth'}); });

  btnCSV.addEventListener('click', ()=>exportar('csv'));
  btnJSON.addEventListener('click', ()=>exportar('json'));
  btnClear.addEventListener('click', ()=>{
    if(confirm('Esto borrará el historial guardado en este dispositivo. ¿Continuar?')){
      historial = []; saveHistorial();
    }
  });

  ans.addEventListener('keypress', (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); check(); }
  });

  const keys = ['7','8','9','4','5','6','1','2','3','0','borrar','ok'];
  function rebuildKeypad(){
    keypad.innerHTML='';
    const puedeNeg = (selOp.value!=='suma' && !chkSinNeg.checked);
    const layout = puedeNeg ? [...keys.slice(0,10), '-', ...keys.slice(10)] : keys;
    layout.forEach(k=>{
      const b=document.createElement('button');
      b.type='button'; b.textContent = k==='borrar'?'⌫ Borrar' : (k==='ok'?'✓ OK':k);
      b.addEventListener('click', ()=>{
        if(k==='borrar'){ ans.value = ans.value.slice(0,-1); ans.focus(); return; }
        if(k==='ok'){ check(); return; }
        if(k==='-'){
          if(puedeNeg && ans.value.indexOf('-')===-1){ ans.value = '-' + ans.value; }
        }else{
          if(ans.value==='0') ans.value='';
          ans.value += k;
        }
        ans.focus();
      });
      keypad.appendChild(b);
    });
  }
  rebuildKeypad();
  selOp.addEventListener('change', rebuildKeypad);
  chkSinNeg.addEventListener('change', rebuildKeypad);

  window.addEventListener('load', ()=> btnStart.focus());
})();
</script>
</body>
</html>
